import pylcp
import numpy as np
from scipy import constants as const
from sympy.physics.wigner import wigner_3j, wigner_6j, wigner_9j
import time
import pathos
import multiprocessing as mp
import dill

gamma = 2*np.pi*84e6 # Hz
k = 2*np.pi/227.5e-9 # m^-1

t_unit = 1/gamma
#t_unit = 1e-1

m_unit = 1/k
#m_unit = 1e-9

velocity_unit = m_unit/t_unit
accel_unit = m_unit/t_unit**2
Hz_unit = 1/t_unit
Js_unit = const.hbar # kg m^2/s
mass_unit = Js_unit*t_unit/m_unit**2
HzperT_unit = const.value("Bohr magneton")/(Js_unit)
T_unit = Hz_unit/HzperT_unit
amu_unit = mass_unit/1.66e-27
cm_unit = m_unit/1e-2
F_unit = mass_unit*m_unit/t_unit**2
I_sat = (np.pi*const.h*const.c*gamma)/(3*227.5e-9**3) # W/m^2

ksim=k*m_unit
gammasim=gamma/Hz_unit

labels = [(3/2,1),(3/2,2),(5/2,2),(5/2,3),(7/2,3),(7/2,4)]
full_labels = np.concatenate([[(i[0], i[1], j) for j in np.arange(-i[1],i[1]+1,1)] for i in labels])

mu_q = {}
d_q = {}
H0 = {}

mu_q['X(v=0)'] = np.zeros((3,full_labels.shape[0],full_labels.shape[0]))
#mu_q['X(v=1)'] = np.zeros((3,full_labels.shape[0],full_labels.shape[0]))
H0['X(v=0)'] = (2*np.pi/Hz_unit)*np.diag(np.concatenate([[11.235e6]*8, [0]*12, [7.914e6]*16]))
#H0['X(v=1)'] = np.zeros((full_labels.shape[0],full_labels.shape[0]))
H0['A(v=0)'] = (2*np.pi/Hz_unit)*np.diag([9.06039e7, 9.06039e7, 9.06039e7, 0., 0., 0., 0., 0., 2.09987e8, 2.09987e8, 2.09987e8, 2.09987e8, 2.09987e8, 1.99498e8, 1.99498e8, 1.99498e8, 1.99498e8, 1.99498e8, 1.99498e8, 1.99498e8, 3.61039e8, 3.61039e8, 3.61039e8, 3.61039e8, 3.61039e8, 3.61039e8, 3.61039e8, 4.36374e8, 4.36374e8, 4.36374e8, 4.36374e8, 4.36374e8, 4.36374e8, 4.36374e8, 4.36374e8, 4.36374e8])

def AState_mu_q(J, lbls, I1, I2): # for the A1Pi state
    Lambda = 1
    def matrix_element(p,F1,F,MF,F1p,Fp,MFp):
        return float((-1)**(F-MF)*wigner_3j(F,1,Fp,-MF,p,MFp)*np.sqrt(3*(2*F+1)*(2*Fp+1))*wigner_9j(F,Fp,1,F1,F1p,1,I2,I2,0)*np.sqrt(3*(2*F1+1)*(2*F1p+1))*wigner_9j(F1,F1p,1,J,J,1,I1,I1,0)*Lambda*(-1)**(J-Lambda)*np.sqrt((2*J+1)*(2*J+1))*wigner_3j(J,1,J,-Lambda,0,Lambda))
    return np.array([[[matrix_element(i,*l2,*l1) for l2 in lbls] for l1 in lbls] for i in [-1,0,1]])
mu_q['A(v=0)'] = AState_mu_q(1, full_labels, 5/2,1/2)

dijq = np.array([[[0.,-0.,0.,-0.05505523,0.,-0.,0.,-0.,-0.66785852,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.35310312,-0.,0.,-0.,-0.03892993,-0.,0.,-0.,-0.,-0.47224729,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,0.35310312,0.,-0.,0.,-0.02247621,0.,-0.,-0.,0.,-0.2726521,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.27075745,0.,-0.,0.,-0.,0.,-0.,-0.518019,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.07277687,-0.,0.,-0.,0.,-0.16796935,0.,-0.,0.,-0.,-0.,-0.22107253,-0.,0.,-0.,0.,-0.,-0.,-0.42296075,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.26454644,-0.,0.,0.,0.0891331,0.,-0.,0.,-0.,-0.2057196,-0.,0.,-0.,-0.,0.,-0.17124205,0.,-0.,0.,-0.,-0.,0.,-0.32762399,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,0.45820787,0.,0.,-0.,0.0891331,-0.,0.,-0.,0.,-0.2057196,0.,-0.,-0.,0.,-0.,-0.12108641,-0.,0.,-0.,-0.,0.,-0.,-0.23166514,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.64800379,0.,-0.,0.,0.07277687,0.,-0.,0.,-0.,-0.16796935,-0.,-0.,0.,-0.,0.,-0.06990927,0.,-0.,-0.,0.,-0.,0.,-0.13375193,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.63021238,-0.,0.,-0.,0.,-0.,0.,-0.26048402,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.32370517,0.,-0.,0.,-0.,-0.01697994,0.,-0.,0.,-0.,0.,0.51456625,0.,-0.,0.,-0.,0.,-0.,-0.21268431,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.07126583,-0.,0.,-0.,-0.39645625,-0.,0.,-0.,-0.,-0.0207961,-0.,0.,-0.,0.,-0.,0.39858131,-0.,0.,-0.,0.,-0.,0.,-0.16474456,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,0.12343605,0.,-0.,0.,-0.39645625,0.,-0.,-0.,0.,-0.0207961,0.,-0.,0.,-0.,0.,0.28183954,0.,-0.,0.,-0.,0.,-0.,-0.116492,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.17456493,-0.,0.,-0.,-0.32370517,-0.,-0.,0.,-0.,-0.01697994,-0.,0.,-0.,0.,-0.,0.16272014,-0.,0.,-0.,0.,-0.,0.,-0.06725668,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.59645448,0.,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.08413443,0.,-0.,0.,-0.,0.,-0.,0.1035144,-0.,0.,-0.,0.,-0.,0.,-0.,-0.51654474,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.17098982,-0.,0.,-0.,0.,-0.0462408,0.,-0.,0.,-0.,-0.,-0.10861708,-0.,0.,-0.,0.,-0.,0.,0.13363651,0.,-0.,0.,-0.,0.,-0.,0.,-0.43655998,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,0.29616305,0.,-0.,0.,-0.,-0.08009142,-0.,0.,-0.,-0.,0.,-0.11898405,0.,-0.,0.,-0.,0.,-0.,0.14639146,-0.,0.,-0.,0.,-0.,0.,-0.,-0.35644973,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.4188378,-0.,0.,-0.,0.,-0.11326637,0.,-0.,-0.,0.,-0.,-0.11898405,-0.,0.,-0.,0.,-0.,0.,0.14639146,0.,-0.,0.,-0.,0.,-0.,0.,-0.27610477,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,0.54071728,0.,-0.,0.,-0.,-0.14622626,-0.,-0.,0.,-0.,0.,-0.10861708,0.,-0.,0.,-0.,0.,-0.,0.13363651,-0.,0.,-0.,0.,-0.,0.,-0.,-0.19523556,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.66224071,-0.,0.,-0.,0.,-0.17908986,-0.,0.,-0.,0.,-0.,-0.08413443,-0.,0.,-0.,0.,-0.,0.,0.1035144,0.,-0.,0.,-0.,0.,-0.,0.,-0.1127193,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.13070954,0.,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.089639,0.,-0.,0.,-0.,0.,-0.,-0.38954428,0.,-0.,0.,-0.,0.,-0.,-0.,-0.11319778,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.0501125,-0.,0.,-0.,0.,0.14201886,-0.,0.,-0.,0.,-0.,-0.11572346,-0.,0.,-0.,0.,-0.,-0.,-0.5028995,-0.,0.,-0.,0.,-0.,-0.,0.,-0.09566959,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,0.0867974,0.,-0.,0.,0.,0.24598388,0.,-0.,0.,-0.,0.,-0.1267687,0.,-0.,0.,-0.,-0.,0.,-0.5508988,0.,-0.,0.,-0.,-0.,0.,-0.,-0.07811389,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.12275006,-0.,0.,0.,-0.,0.34787374,-0.,0.,-0.,0.,-0.,-0.1267687,-0.,0.,-0.,-0.,0.,-0.,-0.5508988,-0.,0.,-0.,-0.,0.,-0.,0.,-0.06050676,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,0.15846965,0.,0.,-0.,0.,0.44910307,0.,-0.,0.,-0.,0.,-0.11572346,0.,-0.,-0.,0.,-0.,0.,-0.5028995,0.,-0.,-0.,0.,-0.,0.,-0.,-0.04278474,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.19408489,0.,-0.,0.,-0.,0.55003668,-0.,0.,-0.,0.,-0.,-0.089639,-0.,-0.,0.,-0.,0.,-0.,-0.38954428,-0.,-0.,0.,-0.,0.,-0.,0.,-0.02470178,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.35416298,0.,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.11414753,-0.,0.,-0.,0.,-0.,0.,-0.01969524,0.,-0.,0.,-0.,0.,-0.,-0.,-0.46851358,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,0.19770933,0.,-0.,0.,-0.,0.,-0.,-0.03411316,-0.,0.,-0.,0.,-0.,-0.,0.,-0.53124446,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.27960322,-0.,0.,-0.,0.,-0.,0.,-0.04824329,0.,-0.,0.,-0.,-0.,0.,-0.,-0.55998083,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,0.3609662,0.,-0.,0.,-0.,0.,-0.,-0.06228182,-0.,0.,-0.,-0.,0.,-0.,0.,-0.55998083,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.4420915,-0.,0.,-0.,0.,-0.,0.,-0.07627934,0.,-0.,-0.,0.,-0.,0.,-0.,-0.53124446,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.52308972,0.,-0.,0.,-0.,0.,-0.,-0.09025493,-0.,-0.,0.,-0.,0.,-0.,0.,-0.46851358,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.60401198,-0.,0.,-0.,0.,-0.,0.,-0.10421742,-0.,0.,-0.,0.,-0.,0.,-0.,-0.35416298,-0.]],[[-0.35310312,-0.,0.,-0.,-0.03892993,-0.,0.,-0.,-0.,-0.47224729,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.,0.,-0.04495241,0.,-0.,-0.,0.,-0.54530419,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.35310312,-0.,0.,-0.,-0.03892993,-0.,-0.,0.,-0.,-0.47224729,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.10292204,-0.,0.,-0.,0.,0.23754453,0.,-0.,0.,-0.,-0.,-0.15632189,-0.,0.,-0.,0.,-0.,-0.,-0.29907841,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[-0.45820787,-0.,0.,0.,-0.05146102,0.,-0.,0.,-0.,0.11877227,-0.,0.,-0.,-0.,0.,-0.19773328,0.,-0.,0.,-0.,-0.,0.,-0.37830759,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.52909288,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,-0.20972782,-0.,0.,-0.,-0.,0.,-0.,-0.4012558,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,-0.45820787,0.,-0.,0.,0.05146102,0.,-0.,0.,-0.,-0.11877227,-0.,-0.,0.,-0.,0.,-0.19773328,0.,-0.,-0.,0.,-0.,0.,-0.37830759,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.10292204,-0.,0.,-0.,0.,-0.23754453,-0.,0.,-0.,0.,-0.,-0.15632189,-0.,-0.,0.,-0.,0.,-0.,-0.29907841,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.45778825,0.,-0.,0.,-0.,0.02401326,0.,-0.,0.,-0.,0.,0.36385329,0.,-0.,0.,-0.,0.,-0.,-0.15039052,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[-0.12343605,-0.,0.,-0.,0.22889412,-0.,0.,-0.,-0.,0.01200663,-0.,0.,-0.,0.,-0.,0.46024205,-0.,0.,-0.,0.,-0.,0.,-0.19023063,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.14253167,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.48816041,0.,-0.,0.,-0.,0.,-0.,-0.20177005,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,-0.12343605,-0.,0.,-0.,-0.22889412,-0.,-0.,0.,-0.,-0.01200663,-0.,0.,-0.,0.,-0.,0.46024205,-0.,0.,-0.,0.,-0.,0.,-0.19023063,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.,0.,-0.,0.,-0.45778825,-0.,0.,-0.,0.,-0.02401326,0.,-0.,0.,-0.,0.,0.36385329,0.,-0.,0.,-0.,0.,-0.,-0.15039052,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.1457251,0.,-0.,0.,-0.,0.,-0.,-0.17929219,-0.,0.,-0.,0.,-0.,0.,-0.,-0.29822724,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,-0.38234485,-0.,0.,-0.,0.,0.10339758,0.,-0.,0.,-0.,-0.,0.09715007,-0.,0.,-0.,0.,-0.,0.,-0.11952813,0.,-0.,0.,-0.,0.,-0.,0.,-0.39047112,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.48363223,0.,-0.,0.,-0.,0.13078874,-0.,0.,-0.,-0.,0.,0.04857503,0.,-0.,0.,-0.,0.,-0.,-0.05976406,-0.,0.,-0.,0.,-0.,0.,-0.,-0.43655998,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,-0.51296945,-0.,0.,-0.,0.,0.13872241,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.45087721,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.48363223,0.,-0.,0.,-0.,0.13078874,-0.,-0.,0.,-0.,0.,-0.04857503,0.,-0.,0.,-0.,0.,-0.,0.05976406,-0.,0.,-0.,0.,-0.,0.,-0.,-0.43655998,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,-0.38234485,-0.,0.,-0.,0.,0.10339758,-0.,0.,-0.,0.,-0.,-0.09715007,-0.,0.,-0.,0.,-0.,0.,0.11952813,0.,-0.,0.,-0.,0.,-0.,0.,-0.39047112,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.1457251,0.,-0.,0.,-0.,0.,-0.,0.17929219,-0.,0.,-0.,0.,-0.,0.,-0.,-0.29822724,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.15525931,0.,-0.,0.,-0.,0.,-0.,0.67471048,0.,-0.,0.,-0.,0.,-0.,-0.,-0.06535477,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,-0.11205496,-0.,0.,-0.,0.,-0.31756382,-0.,0.,-0.,0.,-0.,0.10350621,-0.,0.,-0.,0.,-0.,-0.,0.44980699,-0.,0.,-0.,0.,-0.,-0.,0.,-0.08556948,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.14173956,0.,-0.,0.,0.,-0.40169,0.,-0.,0.,-0.,0.,0.0517531,0.,-0.,0.,-0.,-0.,0.,0.22490349,0.,-0.,0.,-0.,-0.,0.,-0.,-0.09566959,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,-0.15033751,-0.,0.,0.,-0.,-0.42605658,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.09880713,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.14173956,0.,0.,-0.,0.,-0.40169,0.,-0.,0.,-0.,0.,-0.0517531,0.,-0.,-0.,0.,-0.,0.,-0.22490349,0.,-0.,-0.,0.,-0.,0.,-0.,-0.09566959,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,-0.11205496,0.,-0.,0.,-0.,-0.31756382,-0.,0.,-0.,0.,-0.,-0.10350621,-0.,-0.,0.,-0.,0.,-0.,-0.44980699,-0.,-0.,0.,-0.,0.,-0.,0.,-0.08556948,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.15525931,-0.,0.,-0.,0.,-0.,0.,-0.67471048,-0.,0.,-0.,0.,-0.,0.,-0.,-0.06535477,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.70832595,0.,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.30200599,-0.,0.,-0.,0.,-0.,0.,0.05210871,0.,-0.,0.,-0.,0.,-0.,-0.,0.53124446,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.39541866,0.,-0.,0.,-0.,0.,-0.,0.06822631,-0.,0.,-0.,0.,-0.,-0.,0.,0.35416298,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,-0.4420915,-0.,0.,-0.,0.,-0.,0.,0.07627934,0.,-0.,0.,-0.,-0.,0.,-0.,0.17708149,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.45659014,0.,-0.,0.,-0.,0.,-0.,0.07878096,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,-0.4420915,-0.,0.,-0.,0.,-0.,0.,0.07627934,0.,-0.,-0.,0.,-0.,0.,-0.,-0.17708149,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.39541866,0.,-0.,0.,-0.,0.,-0.,0.06822631,-0.,-0.,0.,-0.,0.,-0.,0.,-0.35416298,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,-0.30200599,-0.,0.,-0.,0.,-0.,0.,0.05210871,-0.,0.,-0.,0.,-0.,0.,-0.,-0.53124446,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.70832595]],[[0.,-0.35310312,0.,-0.,0.,-0.02247621,0.,-0.,-0.,0.,-0.2726521,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,-0.35310312,-0.,0.,-0.,-0.03892993,-0.,-0.,0.,-0.,-0.47224729,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.,0.,-0.,0.,-0.05505523,-0.,0.,-0.,0.,-0.66785852,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.64800379,-0.,0.,0.,-0.07277687,0.,-0.,0.,-0.,0.16796935,-0.,0.,-0.,-0.,0.,-0.06990927,0.,-0.,0.,-0.,-0.,0.,-0.13375193,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,0.45820787,0.,0.,-0.,-0.0891331,-0.,0.,-0.,0.,0.2057196,0.,-0.,-0.,0.,-0.,-0.12108641,-0.,0.,-0.,-0.,0.,-0.,-0.23166514,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.26454644,0.,-0.,0.,-0.0891331,0.,-0.,0.,-0.,0.2057196,-0.,-0.,0.,-0.,0.,-0.17124205,0.,-0.,-0.,0.,-0.,0.,-0.32762399,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.,-0.,0.,-0.,-0.07277687,-0.,0.,-0.,0.,0.16796935,-0.,0.,-0.,0.,-0.,-0.22107253,-0.,-0.,0.,-0.,0.,-0.,-0.42296075,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.27075745,-0.,0.,-0.,0.,-0.,0.,-0.518019,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.17456493,-0.,0.,-0.,0.32370517,-0.,0.,-0.,-0.,0.01697994,-0.,0.,-0.,0.,-0.,0.16272014,-0.,0.,-0.,0.,-0.,0.,-0.06725668,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,0.12343605,0.,-0.,0.,0.39645625,0.,-0.,-0.,0.,0.0207961,0.,-0.,0.,-0.,0.,0.28183954,0.,-0.,0.,-0.,0.,-0.,-0.116492,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.07126583,-0.,0.,-0.,0.39645625,-0.,-0.,0.,-0.,0.0207961,-0.,0.,-0.,0.,-0.,0.39858131,-0.,0.,-0.,0.,-0.,0.,-0.16474456,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.,0.,-0.,0.,0.32370517,-0.,0.,-0.,0.,0.01697994,0.,-0.,0.,-0.,0.,0.51456625,0.,-0.,0.,-0.,0.,-0.,-0.21268431,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.63021238,-0.,0.,-0.,0.,-0.,0.,-0.26048402,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.],[0.,-0.,0.,0.66224071,-0.,0.,-0.,0.,-0.17908986,0.,-0.,0.,-0.,-0.,0.08413443,-0.,0.,-0.,0.,-0.,0.,-0.1035144,0.,-0.,0.,-0.,0.,-0.,0.,-0.1127193,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,0.54071728,0.,-0.,0.,-0.,-0.14622626,-0.,0.,-0.,-0.,0.,0.10861708,0.,-0.,0.,-0.,0.,-0.,-0.13363651,-0.,0.,-0.,0.,-0.,0.,-0.,-0.19523556,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.4188378,-0.,0.,-0.,0.,-0.11326637,0.,-0.,-0.,0.,-0.,0.11898405,-0.,0.,-0.,0.,-0.,0.,-0.14639146,0.,-0.,0.,-0.,0.,-0.,0.,-0.27610477,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,0.29616305,0.,-0.,0.,-0.,-0.08009142,-0.,-0.,0.,-0.,0.,0.11898405,0.,-0.,0.,-0.,0.,-0.,-0.14639146,-0.,0.,-0.,0.,-0.,0.,-0.,-0.35644973,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.17098982,-0.,0.,-0.,0.,-0.0462408,-0.,0.,-0.,0.,-0.,0.10861708,-0.,0.,-0.,0.,-0.,0.,-0.13363651,0.,-0.,0.,-0.,0.,-0.,0.,-0.43655998,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,0.08413443,0.,-0.,0.,-0.,0.,-0.,-0.1035144,-0.,0.,-0.,0.,-0.,0.,-0.,-0.51654474,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.59645448],[0.,-0.,0.,0.19408489,-0.,0.,-0.,0.,0.55003668,-0.,0.,-0.,0.,-0.,0.089639,-0.,0.,-0.,0.,-0.,-0.,0.38954428,-0.,0.,-0.,0.,-0.,-0.,0.,-0.02470178,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,0.15846965,0.,-0.,0.,0.,0.44910307,0.,-0.,0.,-0.,0.,0.11572346,0.,-0.,0.,-0.,-0.,0.,0.5028995,0.,-0.,0.,-0.,-0.,0.,-0.,-0.04278474,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.12275006,-0.,0.,0.,-0.,0.34787374,-0.,0.,-0.,0.,-0.,0.1267687,-0.,0.,-0.,-0.,0.,-0.,0.5508988,-0.,0.,-0.,-0.,0.,-0.,0.,-0.06050676,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,0.0867974,0.,0.,-0.,0.,0.24598388,0.,-0.,0.,-0.,0.,0.1267687,0.,-0.,-0.,0.,-0.,0.,0.5508988,0.,-0.,-0.,0.,-0.,0.,-0.,-0.07811389,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.0501125,0.,-0.,0.,-0.,0.14201886,-0.,0.,-0.,0.,-0.,0.11572346,-0.,-0.,0.,-0.,0.,-0.,0.5028995,-0.,-0.,0.,-0.,0.,-0.,0.,-0.09566959,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.089639,-0.,0.,-0.,0.,-0.,0.,0.38954428,-0.,0.,-0.,0.,-0.,0.,-0.,-0.11319778,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.13070954],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.60401198,-0.,0.,-0.,0.,-0.,0.,-0.10421742,0.,-0.,0.,-0.,0.,-0.,-0.,0.35416298,-0.,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,0.52308972,0.,-0.,0.,-0.,0.,-0.,-0.09025493,-0.,0.,-0.,0.,-0.,-0.,0.,0.46851358,0.,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.4420915,-0.,0.,-0.,0.,-0.,0.,-0.07627934,0.,-0.,0.,-0.,-0.,0.,-0.,0.53124446,-0.,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,0.3609662,0.,-0.,0.,-0.,0.,-0.,-0.06228182,-0.,0.,-0.,-0.,0.,-0.,0.,0.55998083,0.,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.27960322,-0.,0.,-0.,0.,-0.,0.,-0.04824329,0.,-0.,-0.,0.,-0.,0.,-0.,0.55998083,-0.,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.19770933,0.,-0.,0.,-0.,0.,-0.,-0.03411316,-0.,-0.,0.,-0.,0.,-0.,0.,0.53124446,0.,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.11414753,-0.,0.,-0.,0.,-0.,0.,-0.01969524,-0.,0.,-0.,0.,-0.,0.,-0.,0.46851358,-0.],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,0.35416298],[0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.,-0.,0.,-0.,0.,-0.,0.,-0.,0.,-0.]]])
# dijq = np.einsum("ijk->kij",dijq)
d_q[("X(v=0)","A(v=0)")] = dijq#*np.sqrt(0.99)

hamiltonian = pylcp.hamiltonian(mass=46/amu_unit, k=ksim, gamma=gammasim)
[hamiltonian.add_H_0_block(l, H) for l, H in H0.items()]
[hamiltonian.add_mu_q_block(l, mu, muB=1) for l, mu in mu_q.items()]
[hamiltonian.add_d_q_block(l[0],l[1], dq, k=ksim, gamma=gammasim) for l, dq in d_q.items()]
# hamiltonian.add_d_q_block("X(v=0)","A(v=0)",dijq,k=0,gamma=gammasim*0.99)
# hamiltonian.add_d_q_block("A(v=0)","X(v=1)",dijq,k=0,gamma=gammasim*0.01)
# hamiltonian.print_structure()

mag_field = pylcp.fields.quadrupoleMagneticField(1000*1e-4*cm_unit*HzperT_unit/Hz_unit)
no_mag_field = pylcp.fields.quadrupoleMagneticField(0*1e-4*cm_unit*HzperT_unit/Hz_unit)

s = 0.1

def MOT_Beams_nov1(det_MOT, *args):
    return {
    'X(v=0)->A(v=0)' : pylcp.laserBeams([
        {'kvec':np.array([1,0, 0.])*ksim, 'pol':-1, 'delta':det_MOT, 's':s},
        {'kvec':np.array([-1,0, 0.])*ksim, 'pol':-1, 'delta':det_MOT, 's':s},
        {'kvec':np.array([0, -1, 0.])*ksim, 'pol':-1, 'delta':det_MOT, 's':s},
        {'kvec':np.array([0, 1, 0.])*ksim, 'pol':-1, 'delta':det_MOT, 's':s},
        {'kvec':np.array([0., 0.,  1.])*ksim, 'pol':1, 'delta':det_MOT, 's':s},
        {'kvec':np.array([0., 0., -1.])*ksim, 'pol':1, 'delta':det_MOT, 's':s},
    ], beam_type=pylcp.infinitePlaneWaveBeam)}
    

#eqn = pylcp.rateeq(MOT_Beams_nov1(-2*np.pi*43e6/Hz_unit,0,1,2*np.pi*205e6/Hz_unit), mag_field, hamiltonian,include_mag_forces=False)
#num_of_scatters = np.zeros((N_atom,), dtype='int')
#num_of_steps = np.zeros((N_atom,), dtype='int')

def generate_random_solution(args):
    global eqn
    tmax, rng_seed, init_v, init_r = args
    # We need to generate random numbers to prevent solutions from being seeded
    # with the same random number.
    eqn.set_initial_velocity(init_v)
    eqn.set_initial_position(init_r)
    eqn.evolve_motion([0., tmax/t_unit],
                      max_step=1e-9/t_unit,
                      random_recoil=True,
                      #max_scatter_probability=0.25,
                      freeze_axis=[False, False, False],
                      rtol=1e-8,
                      t_eval=np.linspace(0,tmax/t_unit, 1000),
                      atol=np.concatenate(([1e-5]*72*72,[1/velocity_unit,1/velocity_unit,1/velocity_unit,1e-2/cm_unit,1e-2/cm_unit,1e-2/cm_unit])),
                      method="RK23",
                      progress_bar=True,
                      rng=np.random.default_rng(rng_seed))

    return [eqn.sol.v, eqn.sol.t, eqn.sol.r, [tmax*0.999<eqn.sol.t[-1], len(eqn.sol.t_random)]]

eqn = None

def init_worker(eqn_dump):
    global eqn
    eqn = dill.loads(eqn_dump)


v_final = []
import time
if __name__ == "__main__":
    __spec__ = None
    
    # obe = pylcp.obe(MOT_Beams_nov1(-2*np.pi*43e6/Hz_unit,0,1,2*np.pi*205e6/Hz_unit), mag_field, hamiltonian,include_mag_forces=False, transform_into_re_im=True)
    # eqn = obe
    
    # eqn.set_initial_position_and_velocity(np.array([0., 0., 0.]), np.array([0., 0., 0.]))
    # if isinstance(eqn, pylcp.rateeq):
    #     eqn.set_initial_pop_from_equilibrium()
    # elif isinstance(eqn, pylcp.obe):
    #     eqn.set_initial_rho_from_rateeq()
    chunksize = 256
    N_cpus = 256
    N_atom = 256 # Needs to be divisible by chunksize

    # if hasattr(eqn, 'sol'):
    #     del eqn.sol

    eqn = pylcp.obe(MOT_Beams_nov1(-1*gammasim), mag_field, hamiltonian,include_mag_forces=False, transform_into_re_im=False)
    # eqn = dill.load("AlF_nov1_-0.5.dump")
    eqn.set_initial_position_and_velocity(np.array([0., 0., 0.]), np.array([0., 0., 0.]))
    if isinstance(eqn, pylcp.rateeq):
        eqn.set_initial_pop_from_equilibrium()
    elif isinstance(eqn, pylcp.obe):
        eqn.set_initial_rho_from_rateeq()
    if hasattr(eqn, 'sol'):
        del eqn.sol
    print(eqn.recoil_velocity['X(v=0)->A(v=0)']*velocity_unit*100," cm/s")

    Rsc = gamma/50
    runtime = 15*46*1.66e-27*gamma/(2*(k**2)*Rsc*const.hbar)
    runtime = 3e-3 # 3ms

    init_vx = lambda T : np.random.normal(0, np.sqrt(1.380e-23*T/(46*1.66e-27)))
    init_rx = lambda : np.random.normal(0, 0.2/cm_unit)
    T_init = 2e-3

    # print(eqn.recoil_velocity['X(v=0)->A(v=0)']*velocity_unit*100," cm/s")
    ss = lambda : np.random.SeedSequence(time.time_ns()) # "It's the same combination as my luggage!"
    # child_seeds = ss.spawn(N_atom)
    # with pathos.pools.ProcessPool(ncpus=4) as pool:
    #     v_final += pool.map(
    #         generate_random_solution,
    #         N_atom*[eqn],
    #         N_atom*[runtime],
    #         child_seeds
    #     )
    
    with mp.Pool(processes=N_cpus, initializer=init_worker, initargs=(dill.dumps(eqn),)) as pool:
        v_final = pool.map(generate_random_solution, [[runtime, seed, np.array([init_vx(T_init)/velocity_unit,init_vx(T_init)/velocity_unit,init_vx(T_init)/velocity_unit]),np.array([init_rx(), init_rx(), init_rx()])] for seed in ss().spawn(N_atom)])
    
    stats = np.array([f[3] for f in v_final])
    np.savez("out.npz", v=[f[0] for f in v_final], ts=[f[1] for f in v_final], r=[f[2] for f in v_final], stats=stats)
